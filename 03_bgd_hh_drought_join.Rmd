---
title: "Match household and drought data"
output: html_document
date: "2024-11-12"
---
TO-DO: Use zonal statistics function

Note: the SPEI data is quite aggregated and multiple unions will likely fall within one grid cell. However, the issue is that when I perform a spatial join only one match is found.Make sure that all BIHS locations can be matched with a SPEI value. 

Okay, this doesn't really work --> I think the over function takes the centroid of my coordinate points rather than the entire area covered by the grid cell. I can fix this by converting my coordinate points to polygons then trying to find overlap in areas between polygons.

New idea: Use the disaggregate command! It will create more data points at a higher spatial resolution (even though the actual values are all the same). This helps for the purposes of a spatial join though. The issue atm is that the 47 grid cells do not actually cover the entiretly of Bangladesh:( You can also play around with different spatial resolutions of the disaggregation 

## Match SPEI with BIHS ##

```{r}
# Make a new data frame
spei_geo <- spei_2010_2020

# Create another shapefile
test_data <- bgd_test

# Turn data frame into a raster for spatial disaggregation 
raster_spei <- rasterFromXYZ(spei_geo)

# Make sure the CRS is consistent with shapefile
proj4string(raster_spei) <- CRS("+proj=longlat +datum=WGS84 +no_defs")

# Disaggregate - this will create a "higher resolution" grid, even though the values of the points falling within the larger grid cell will be the same, this wil allow for the spatial join with a shapefile so that each union has its distinct SPEI data point. You can play around with the factor of disaggregation.
raster_spei_disag <-  disaggregate(raster_spei, fact=200)

# Turn back into a data frame - now we have more data points
spei_df <- as.data.frame(raster_spei_disag, xy=TRUE)

# Remove NA values
spei_df <- na.omit(spei_df)

# Turn into a spatial data frame for a spatial join with the shapefile 
spei_df$x <- as.numeric(spei_df$x)
spei_df$y <- as.numeric(spei_df$y)
coordinates(spei_df) <- ~x+y

# Set CRS as the same - taken from shapefile
proj4string(spei_df) <- CRS("+proj=longlat +datum=WGS84 +no_defs")

# Perform a spatial join with the Bangladesh shapefile
ID <- over(test_data, spei_df)                               
test_data@data <- cbind(test_data@data , ID )  

# Turn back into a data frame  
test_data <- as.data.frame(test_data)

# Check if there are any NA values - currently 6
summary(test_data)

```

Now match the union-level SPEI information with BIHS locations of households 

```{r BIHS locations SPEI }
# Make new data frame for this 
bgd_spei <- test_data

# Create a new data frame with compatible codes
# Remove unnecessary columns

bgd_spei <- bgd_spei[ , !names(bgd_spei) %in% 
    c("ADM4_REF","ADM4ALT1EN", "ADM4ALT2EN")]

# Rename the code identifiers for administrative levels - remove BD
bgd_spei$ADM4_PCODE <- substr(bgd_spei$ADM4_PCODE, 3, 10)

# Remove the first 2 digits from the union code (those refer to admin level 1)
bgd_spei$ADM4_PCODE <- substr(bgd_spei$ADM4_PCODE, 3, 10)

# This is correct for most cases. However, whenever "0" is the first digit, we should delete it 

# Change to numeric - this will drop 0 at the front 
bgd_spei$ADM4_PCODE <- as.numeric(bgd_spei$ADM4_PCODE)

# Back to character 
bgd_spei$ADM4_PCODE <- as.character(bgd_spei$ADM4_PCODE)

# Rename columns in BIHS_admin before the join 
names(BIHS_admin)[names(BIHS_admin) == "uncode"] <- "ADM4_PCODE"

# Back to character for compatibility of the merge
bgd_spei$ADM4_PCODE <- as.character(bgd_spei$ADM4_PCODE)
BIHS_admin$ADM4_PCODE <- as.character(BIHS_admin$ADM4_PCODE)


```

## Inspect the union codes that did not match manually, then join dataframes ##

For all 14 cases, look at the Stata dta file with BIHS locations that also has labels with names in English. On that basis, find the corresponding ADM4_PCODE in the shapefile, which is different.

1. BIHS code: 193617, BIHS name: Bitikandi, Shapefile ADM4_PCODE: 199417
2. BIHS code: 198104, BIHS name: Akubpur, Shapefile ADM4_PCODE: 198110
3. BIHS code: 338609, BIHS name: Barmi, Shapefile ADM4_PCODE: 338621
4. BIHS code: 354306, BIHS name: Bethuri, Shapefile ADM4_PCODE: 354311
5. BIHS code: 827395, BIHS name: Saorail, Shapefile ADM4_PCODE: 824795
6. BIHS code: 935780, BIHS name: Musuddi, Shapefile ADM4_PCODE: 932580
7. BIHS code: 102056, BIHS name: Majhira , Shapefile ADM4_PCODE: 108556
8. BIHS code: 105409, BIHS name: Bir Kedar, Shapefile ADM4_PCODE: 105413
9. BIHS code: 386109, BIHS name: Alampur, Shapefile ADM4_PCODE: 386115
10. BIHS code: 696312, BIHS name: Bara Harishpur, Shapefile ADM4_PCODE: 696320
11. BIHS code: 496106, BIHS name: Ballabher Khas, Shapefile ADM4_PCODE: 496111
12. BIHS code: 855816, BIHS name: Bara Hazratpur, Shapefile ADM4_PCODE: 855826
13. BIHS code: 857309, BIHS name: Annadanagar, Shapefile ADM4_PCODE: 857317
14. BIHS code: 857650, BIHS name:  Madankhali, Shapefile ADM4_PCODE: 857656


```{r union codes}
	
# Look up the union code associated with an English name of the union in the Bangladesh shapefile
with(bgd_spei, ADM4_PCODE[ADM4_EN =="Madankhali"])

# Create another data frame with values from the Bangladesh shapefile to replace with new matching codes. Here I replace shapefile codes with codes from BIHS.
bgd_spei_newcodes <- bgd_spei

# Now replace admin 4 codes
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="199417"] <- "193617"  #1
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="198110"] <- "198104"  #2
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="338621"] <- "338609"  #3
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="354311"] <- "354306"  #4
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="824795"] <- "827395"  #5 
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="932580"] <- "935780"  #6
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="108556"] <- "102056"  #7
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="105413"] <- "105409"  #8
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="386115"] <- "386109"  #9
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="696320"] <- "696312"  #10
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="496111"] <- "496106"  #11
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="855826"] <- "855816"  #12
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="857317"] <- "857309"  #13
bgd_spei_newcodes$ADM4_PCODE[bgd_spei_newcodes$ADM4_PCODE=="857656"] <- "857650"  #14

# Left join - just to see how many observations overlap.
BIHS_drought <- left_join(BIHS_admin, bgd_spei_newcodes)

# Remove ugly columns
BIHS_drought <- BIHS_drought[ , !names(BIHS_drought) %in% 
    c("date","validTo", "validOn")]

# Export BIHS data matched with flood data a csv file where the "ADM4_PCODE" column corresponds to the "uncode" column from the BIHS data. 
write.csv(BIHS_drought, "BIHS_drought.csv")

# Check for missing values - no NAs :)
summary(BIHS_drought)

```

